#!/bin/bash

[[ -d "/tmp/emulators" ]] && rm -r "/tmp/emulators"
[[ ! -d "/usr/share/server/emulators" ]] && mkdir -p "/usr/share/server/emulators"

mkdir "/tmp/emulators"

emulators="/usr/share/server/emulators"
tmpfolder="/tmp/emulators"

#Compiling psx emulator
if [[ ! -d "$emulators/ps1" ]]; then
    git clone "https://github.com/stenzek/duckstation.git" -b dev "$tmpfolder/ps1"
    mkdir "$tmpfolder/ps1/build/"
    cd "$tmpfolder/ps1/build"
    cmake -DCMAKE_BUILD_TYPE=Release -GNinja "$tmpfolder/ps1/"
    ninja 
    mv "$tmpfolder/ps1/build/bin" "$emulators/ps1"
    ln -s "/rpi/memcards/ps1" "/home/crossgame/.local/share/duckstation/memcards"
    chown crossgame:crossgame "/rpi/memcards/ps1"
fi

#Compiling ps2 emulator
if [[ ! -d "$emulators/ps2" ]]; then
    git clone --recurse-submodules "https://github.com/jpd002/Play-.git" "$tmpfolder/ps2"
    mkdir "$tmpfolder/ps2/build/"
    cd "$tmpfolder/ps2/build"
    sed -i "s/ OR TARGET_PLATFORM_UNIX_ARM OR TARGET_PLATFORM_UNIX_AARCH64//" "$tmpfolder/ps2/deps/Framework/build_cmake/FrameworkOpenGl/CMakeLists.txt"
    cmake -G Ninja -DCMAKE_PREFIX_PATH=/opt/qt56/ "$tmpfolder/ps2/"
    cmake --build "$tmpfolder/ps2/build" --config Release
    mv "/$tmpfolder/ps2/build/Source/ui_qt" "$emulators/ps2"
fi

# Compiling psp emulator
if [[ ! -d "$emulators/psp" ]]; then
    git clone --recurse-submodules "https://github.com/hrydgard/ppsspp.git" "$tmpfolder/psp"
    mkdir "$tmpfolder/psp/build/"
    cd "$tmpfolder/psp/build/"
    cmake ..
    cmake -j 4 ..
    make install
    mkdir "$emulators/psp"
    cp "$tmpfolder/psp/build/PPSSPPSDL" "$emulators/psp/"
    ln -s "/rpi/memcards/psp" "/home/crossgame/.config/ppsspp/PSP/SAVEDATA"
    chown crossgame:crossgame "/rpi/memcards/psp"
fi